(function() {
    const rxjs = require('rxjs');
    const _ = require('lodash');

    class BoardsManager {

        constructor() {
            this.serialService = require("./serial.js");            
            this.boardManager = require("./board.js");
            this.boards={};

            this.boardSubject = new rxjs.BehaviorSubject();
            this.boardObservable = this.boardSubject.asObservable();

            this.connectedSubject = new rxjs.BehaviorSubject();
            this.boardObservable = this.boardSubject.asObservable();

            this.updateSubject = new rxjs.Subject();
            this.update = this.updateSubject.asObservable();

            this.boardsSubject = new rxjs.BehaviorSubject();
            this.boardsObservable = this.boardsSubject.asObservable();
        }

        init() {
            console.log('BoardsManager: Initialising manager');

            // LetÂ´s subscribe to new serial ports
            this.serialService.ports
            .subscribe(ports => {
                console.log('CommunicationController: Ports detected');
                _.each(ports, port => {
                    this.connectBoard(port);
                })
            });
            
        }

        connectBoard(port) {
            const board = new this.boardManager(port);
            this.boards[port] = board;
            this.boardsSubject.next(this.boards);
            this.boardSubject.next(board);

            board.update.subscribe(() => {
                this.updateSubject.next();
            })
    
            board.state.subscribe((state) => {
                if (state==='disconnected') {
                    this.boards[port]=null;
                    this.boardsSubject.next(this.boards);
                    this.updateSubject.next();
                    console.log(this.boards);
                }
            });
        };

        getBoardNames() {
            return _.keys(this.boards);
        }

        getBoard(boardId) {
            return this.boards[boardId];
        }
    };

    module.exports = new BoardsManager();
}());