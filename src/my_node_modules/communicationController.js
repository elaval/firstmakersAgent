(function() {
    const rxjs = require('rxjs');
    const _ = require('lodash');
    const boardsManager = require('./boardsManager');

    class CommunicationController {

        constructor() {
            // Keeps previosuly defined sockets associated to each boardName
            this.boardSockets = {};

            // We will have socket.io connection with clients on a root namespace to advertise new boards
            // and we will open namespaced sockets for each board for communication of the board activity
            this.server = require("./server.js");
            this.server.io.on('connection', (socket) => {

                // Advertise each of the boards that has already been connected
                const currentPorts = boardsManager.getBoardNames();
                const isPortAnnounced = {};
                currentPorts.forEach(boardName => {
                    socket.emit("board", boardName);
                    isPortAnnounced[boardName] = true;                    
                })

                // Advertise each boards that will be connected in the future
                boardsManager.boardSubject.subscribe(board => { 
                    if (board && board.portName && !isPortAnnounced[board.portName]) {
                        socket.emit("board", board.portName);
                    }   
                });
            })

            // Create namespaced sockets when new boards are connected
            boardsManager.boardSubject.subscribe(board => {
                if (board) {
                    const boardName = board['portName'];
                    if (this.boardSockets[boardName]) {
                        console.log("PORT RECONNECTED ON THE SERVER: ", board.portName)
                        
                        const socket = this.boardSockets[boardName];
                        this.initialiseSocketAndBoardEvents(board, socket);
                    } else {
                        const nsp = this.server.io.of(`${board.portName}`);

                        nsp.on('connection', (socket) => {
                            console.log("PORT CONNECTED ON THE SERVER: ", board.portName)
                            this.boardSockets[boardName] = socket;

                            this.initialiseSocketAndBoardEvents (board, socket);
                        });
                    }

                    this.boardSubject.next(board)
                }

            });

            this.boardSubject = new rxjs.Subject();
            this.boardObservable = this.boardSubject.asObservable();

            this.updateSubject = new rxjs.Subject();
            this.update = this.updateSubject.asObservable();

            this.boardsSubject = new rxjs.BehaviorSubject([]);
            this.boardsObservable = this.boardsSubject.asObservable();

            boardsManager.init();
            boardsManager.boardsSubject.subscribe(d => {
                this.boardsSubject.next(d)
            });



            boardsManager.updateSubject.subscribe(d => this.updateSubject.next(d));


        }

        initialiseSocketAndBoardEvents(board, socket) {
            // Clean previous listener associated to this socket
            socket.removeAllListeners();
            
            socket.on('pinMode', function(d){
                board.setPinMode(d.pin, d.mode)
            });

            socket.on('pinValue', function(d){
                board.digitalWrite(d.pin, d.value)
            });

            board.analogRead.subscribe(d => {
                socket.emit('analogRead', d);
            })

            board._digitalRead.subscribe(d => {
                socket.emit('digitalRead', d);
            })

            board._pinMode.subscribe(d => {
                if (d) { socket.emit('pinMode', d); }
            })

            board.state.subscribe(d => {
                if (d==='connected') {
                    socket.emit('pins', board.pins);
                    socket.emit('analogPins', board.analogPins);
                }

                socket.emit('state', d);
            })
        }

        init() {}

        getBoards() {
            return this.boards;
        }
    };



    const controller = new CommunicationController();

    module.exports = controller;
}());